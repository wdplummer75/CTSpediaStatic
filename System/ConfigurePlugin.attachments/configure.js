var json_rpc_url="jsonrpc",jsonRpc_reqnum=0,$FALSE=0,$TRUE=1;function _id_ify(e){return"i"+(e=(e=(e=e.replace(/[}{]/g,"-")).replace(/['"]/g,"")).replace(/[^A-Za-z0-9_]/g,"-"))}!function($){"use strict";var auth_action=function(){},confirm_action=function(){};function inline_whirly(e){var t=$('<span class="whirly" />');return e.append(t),window.setTimeout((function(){t.remove()}),1e3),t}function find_modified_values(){var e,t={};return $(".value_modified").each((function(){e=$(this).data("value_handler"),t[e.spec.keys]=e.currentValue()})),t}function update_save_button(e){var t=$(".value_modified").length,a=1==t?"1 change":t>0?t+" changes":"";e&&(t++,a="(required)"),$("#saveButton").button("option","label","Save "+a),$("#bootstrap_warning").length>0&&t++,$("#saveButton").button(t>0?"enable":"disable")}function update_modified_default(e){var t=e.data("value_handler");t.isModified()?(e.addClass("value_modified"),e.find(".undo_button").show(),update_save_button()):(e.removeClass("value_modified"),update_save_button(),e.find(".undo_button").hide()),t.isDefault()?e.find(".default_button").hide():e.find(".default_button").show()}function RPC(e,t,a,n,i){var o,r;o=_id_ify(t)+"_"+jsonRpc_reqnum++,console&&console.debug("Sending "+o),i&&(r=inline_whirly(i)),$.jsonRpc(json_rpc_url,{namespace:"configure",method:e,id:o,params:a,error:function(e,t,a){console&&console.debug(o+" failed"),r&&r.remove(),$.pnotify({title:"Error",text:e.error.message,type:"error",hide:!1,sticker:!1,closer_hover:!1,icon:!1})},success:function(e,t,a){console&&console.debug(o+" OK"),n(e.result),r&&r.remove()}})}function forget_checker_reports(e,t,a){e.removeClass(t+a);var n,i=e.attr("class").split(/ +/);for(n=0;n<i.length&&!i[n].startsWith(t+"i-");n++);n==i.length&&e.removeClass(t);var o=e.data("reports");o[t][a]--,o[t][a]&&delete o[t][a],0===o[t].length&&e.removeClass(t)}function record_checker_reports(e,t,a){e.addClass(t+a);var n=e.data("reports");n||(n={errors:{},warnings:{}},e.data("reports",n)),n[t][a]=!0,e.addClass(t),e.closest("li").addClass(t)}function bubble_checker_reports(e,t){var a,n,i=e.path.join(" > "),o=_id_ify(e.keys);$.each(e.path,(function(r,d){a=_id_ify(d),$.each(t,(function(t,r){0!==r&&"notes"!==t&&(record_checker_reports($("#TAB"+a),t,o),$("#REP"+a).first().each((function(){var a=1==r?t.substr(0,t.length-1):t;(n=$("<div>"+i+" > "+e.keys+" has "+r+" "+a+"</div>")).addClass(t),n.addClass(o+"_report"),$(this).append(n)})))}))}))}function checker_reports(e){$("body").css("cursor","wait"),$.each(e,(function(e,t){var a,n,i,o,r;if(!t.keys)return(a=$('<div id="report_dialog"></div>')).html(TML.render_reports(t.reports)),void a.dialog({modal:!0,width:"auto",minWidth:390,maxWidth:700,minHeight:390,maxHeight:700,buttons:{Close:function(){a.dialog("close"),a.remove()}},close:function(){$("body").css("cursor","auto")}});n=_id_ify(t.keys),$("."+n+"_report").remove(),$(".errors"+n).each((function(){forget_checker_reports($(this),"errors",n)})),$(".warnings"+n).each((function(){forget_checker_reports($(this),"warnings",n)}));var d=$("#"+n+"_block");d.removeClass("errors").removeClass("warnings").removeClass("notes"),i={errors:0,warnings:0},t.reports&&(o=$("#REP"+n),$.each(t.reports,(function(e,t){i[t.level]++,$("#"+n+"_block").addClass(t.level)})),o.length>0&&((r=$("<div></div>")).html(TML.render_reports(t.reports)),r.addClass(n+"_report"),r.addClass("message_block"),o.append(r),t.hints&&t.hints.reset_may_repair&&(d.data("value_handler").restoreDefaultValue(),d.addClass("value_modified"),update_save_button()))),i.errors+i.warnings>0&&t.path&&bubble_checker_reports(t,i)})),$("body").css("cursor","auto")}function check_current_value(e,t){update_modified_default(e);var a=e.data("value_handler"),n={keys:[a.spec.keys],set:find_modified_values(),check_dependencies:t};RPC("check_current_value","Check: "+a.spec.keys,n,checker_reports,e)}function wizard_started(e){var t=e.wizard+"_"+e.method,a=$("#hogwarts"),n=$('<div class="wiz"></div>');n.addClass(t),n.html("<b>Waiting for the server, please be patient:</b><br/>"),n.append((e.wizard?e.wizard+"/":"")+e.method+" is working"),inline_whirly(n),a.append(n),a.hasClass("ui-dialog-content")?a.dialog("isOpen")||a.dialog("open"):a.dialog({title:"Active Wizards",width:"auto"})}function wizard_finished(e){var t=e.wizard+"_"+e.method,a=$("#hogwarts");a.find("."+t).remove(),0==a.find(".wiz").length&&a.dialog("close")}function wizard_reports(e,t,a){var n,i=$('<div class="message_block"></div>');$("body").css("cursor","wait"),i.html(TML.render_reports(a.messages)),a.changes&&$.each(a.changes,(function(e,t){var a=t;a=a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),i.append('<div class="changes">'+e+" = "+a+"</div>")})),i.find(".wizard_button").each((function(){var e,a,n=$(this).data("wizard");$(this).button().click((function(){n.form?(e=$.extend({},n.args),$.each($(n.form).serializeArray(),(function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}))):e=n.args,wizard_started(a={wizard:n.wizard,method:n.method,args:e,set:find_modified_values(),cfgusername:$("#username").val(),cfgpassword:$("#password").val()}),RPC("wizard","Call "+n.method,a,(function(e){wizard_reports(a,t,e)}),$(this))}))})),$.each(a.changes,(function(e,t){var a,n,i,o=!1;$("#"+_id_ify(e)).closest(".node").each((function(){var e=$(this);e.data("value_handler").useVal(t),o=!0,check_current_value(e,!0),e.addClass("value_modified")})),o||(a="pending"+_id_ify(e),0===(n=$("#"+a)).length&&(n=$('<div class="hidden_pending value_modified" id="'+a+'"></div>'),$("#root").append(n)),i={spec:{keys:e},currentValue:function(){return t},isDefault:function(){return!0},isModified:function(){return!0},commitVal:function(){n.removeClass("value_modified")}},n.data("value_handler",i))})),update_save_button(a.hints.require_save),wizard_finished(e),$("body").css("cursor","auto"),(n=$('<div id="report_dialog"></div>')).append(i),n.dialog({title:"Validation",width:"auto",minWidth:390,maxWidth:700,minHeight:390,maxHeight:700,modal:!0,buttons:{Close:function(){n.dialog("close"),n.remove()}},close:function(){$("body").css("cursor","auto")}})}function call_wizard(e,t,a){var n=e.data("value_handler"),i={wizard:t.wizard,method:t.method,keys:n?n.spec.keys:"",set:find_modified_values(),cfgusername:$("#username").val(),cfgpassword:$("#password").val()};wizard_started(i),RPC("wizard","Call "+t.method,i,(function(t){wizard_reports(i,e,t)}),a)}function create_feedback(e,t,a){var n;if(t.method){t.label||(t.label=t.method),t.label||(t.label=t.wizard),n=$('<button class="feedback_button">'+t.label+"</button>"),t.title&&n.attr("title",t.title);var i=t.icon;i||(i="ui-icon-pencil"),n.click((function(){1==t.auth?(auth_action=function(){call_wizard(a,t,a)},$("#auth_note").html(e.title),$("#auth_prompt").dialog("option","title",t.label+" requires authentication"),$("#auth_prompt").dialog("open")):call_wizard(a,t,a)})).button({icon:i}),a.find(".button_box").append(n)}else console&&console.debug("Useless FEEDBACK on "+e.keys)}function load_ui(e){var t,a,n,i,o,r,d,s,c=e.data("spec.entry"),l=c.typename;"function"!=typeof window.Types[l]&&(l="BaseType"),t=new window.Types[l](c),e.data("value_handler",t),a=t.createUI((function(){update_modified_default(e),check_current_value(e,!0)})),e.find(".ui-placeholder").replaceWith(a),r="pending"+_id_ify(c.keys),(d=$("#"+r)).length&&(t.useVal(d.data("value_handler").currentValue()),d.remove()),s=$('<div class="button_box"></div>').insertAfter(a),1===c.CHECK.undefok&&"BOOLEAN"!=c.typename&&(e.addClass("undefinedOK"),n="UOK"+_id_ify(c.keys),(i=$('<input type="checkbox" id="'+n+'">').appendTo(s)).click((function(){$(this).attr("checked")?(a.prop("disabled",!1),e.removeClass("disabled")):(a.attr("disabled","disabled"),e.addClass("disabled")),update_modified_default(e)})),t.null_if=function(){return!i.attr("checked")},void 0===c.current_value||null===c.current_value?(a.attr("disabled","disabled"),e.addClass("disabled")):i.prop("checked",!0),i.appendTo(s),$("<label for='"+n+"'> enable</label>").attr("title","If unchecked, "+c.keys+" will be undefined. Check this box to give it a value.").appendTo(s)),(o=$('<button class="undo_button control_button">undo</button>')).attr("title","Reset to configured value: "+c.current_value),o.click((function(){t.restoreCurrentValue(),check_current_value(e,!0)})).button({icon:"ui-icon-cancel"}).hide(),o.appendTo(s),(o=$('<button class="default_button control_button">reset</button>')).attr("title","Reset to default value: "+c.default),o.click((function(){t.restoreDefaultValue(),check_current_value(e,!0)})).button({icon:"ui-icon-arrowrefresh-1-w"}).hide(),o.appendTo(s),c.FEEDBACK&&$.each(c.FEEDBACK,(function(t,a){create_feedback(c,a,e)})),$("body").trigger("configurecreate",_id_ify(c.keys)),update_modified_default(e)}function load_tab(e,t){t.hasClass("spec_loaded")||($("#TAB"+_id_ify(e.headline)),RPC("getspec","Load: "+e.headline,{get:{parent:{depth:e.depth,headline:e.headline}},depth:0},(function(a){var n=$('<div class="node"></div>');t.append(n),t.addClass("spec_loaded"),e.headline&&n.append("<h2>"+e.headline+"</h2>"),e.desc&&add_desc(e,n),load_section_specs(a,n),RPC("check_current_value","Check: "+e.headline,{keys:[e.headline]},checker_reports)}),t))}function value_of(e){var t=$(e);if(0===t.length)throw e+" has not been loaded yet";return"checkbox"==t.attr("type")?t.is(":checked"):t.val()}function add_dependency(test,$el,cb){var name,keys=[],selector,handler;return test=test.replace(/^(\w+)\s+/,(function(e,t,a){return name=t,""})),test=test.replace(/((?:\{\w+\})+)/g,(function(e,t,a){return selector="#"+_id_ify(t),keys.push(selector),"value_of('"+selector+"')"})),handler=function(event){try{cb($el,!!eval("("+test+")"))}catch(e){console&&console.debug(e)}},$.each(keys,(function(e,t){$(document).on("change",t,null,handler)})),handler}function add_desc(e,t){var a,n,i,o=/^((?:.|\n)*?\.)\s+((?:.|\n)+)$/.exec(e.desc);o?(a=$('<div class="description">'+TML.render(o[1])+"&nbsp;</div>"),t.append(a),n=$('<span class="closed">'+TML.render(o[2])+"</span>"),(i=$('<a class="more">... more</a>')).click((function(){n.is(":visible")?(n.hide(),i.text("... more")):(n.show(),i.text("... less"))})),a.append(n),a.append(i)):t.append('<div class="description">'+TML.render(e.desc)+"</div>"),t.append()}function load_section_specs(e,t){var a=[],n=null,i=null,o={};$.each(e,(function(e,n){var i,o,r,d;"SECTION"!=n.typename&&((o=$('<div class="node load_ui"></div>')).data("spec.entry",n),n.EXPERT&&1==n.EXPERT&&(o.addClass("expert"),"checked"!==$("#showExpert").attr("checked")&&o.addClass("hidden_expert")),void 0!==n.DISPLAY_IF&&a.push(add_dependency(n.DISPLAY_IF,o,(function(e,t){t?e.removeClass("hidden_di"):e.addClass("hidden_di")}))),void 0!==n.ENABLE_IF&&a.push(add_dependency(n.ENABLE_IF,o,(function(e,t){t?e.find("input,textarea").prop("disabled",!1):e.find("input,textarea").attr("disabled","disabled")}))),void 0!==n.keys?(r=_id_ify(n.keys),o.addClass("keyed"),i=n.LABEL?"<b>"+n.LABEL+':</b><div class="keys">'+n.keys+"</div>":"<b>"+n.keys+":</b>",o.append('<div class="label">'+i+'</div><div class="ui-elem clearfix"><span class="ui-placeholder"></span></div>')):null!==n.headline&&(r=_id_ify(n.headline)),o.attr("id",r+"_block"),(d=$('<div class="reports"></div>')).attr("id","REP"+r),o.append(d),n.desc&&add_desc(n,o),n.LABEL,t.append(o))})),$.each(e,(function(e,a){if("SECTION"==a.typename&&!o[a.headline]){o[a.headline]=!0;var r=$('<li><a href="'+json_rpc_url+'"><span class="tab" id="TAB'+_id_ify(a.headline)+'">'+a.headline+"</span></a></li>");a.EXPERT&&1==a.EXPERT&&(r.addClass("expert"),"checked"!==$("#showExpert").attr("checked")&&r.addClass("hidden_expert")),r.data("spec.entry",a),null===n&&(n=$("<div></div>"),t.append(n),i=$("<ul></ul>"),n.append(i)),i.append(r)}})),null!==n&&(n.tabs({beforeLoad:function(e,t){return load_tab($(t.tab).data("spec.entry"),$(t.panel)),!1}}),t.is("#root")&&n.addClass("ui-tabs-vertical ui-helper-clearfix")),t.find(".node.load_ui").each((function(){load_ui($(this).removeClass("load_ui"))})),$.each(a,(function(e,t){t.call()}))}function search(e){var t,a,n=$(".searchResults");t=n.find("ol").empty(),n.find(".errors").remove(),a=n.find(".searchTitle").text("Searching for '"+e+"'"),n.slideDown(),RPC("search","Search: "+e,{search:e},(function(e){var a,n,i=e.length;if(i)for(a=0;a<i;a++)n=e[a].join(" > "),t.append("<li>"+n+"</li>");else $("<div class='errors'>nothing found</div>").insertAfter(t),window.setTimeout((function(){$(".searchResults").slideUp()}),1e3)}),a)}$(document).ready((function(){var e=$("#root"),t="true"===foswiki.getPreference("is_bootstrapped");json_rpc_url=foswiki.getScriptUrlPath("jsonrpc"),t||$("#bootstrap_warning").remove(),$("#auth_prompt").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){$("#auth_prompt").dialog("close"),auth_action()},Cancel:function(){$("#auth_prompt").dialog("close")}}}),$("#confirm_prompt").dialog({autoOpen:!1,modal:!0,buttons:{Confirm:function(){$("#confirm_prompt").dialog("close"),confirm_action()},Cancel:function(){$("#confirm_prompt").dialog("close")}}}),$("#closeSearchButton").button().click((function(){$(".searchResults").slideUp()})),$("#searchButton").button({icon:"ui-icon-search",text:!1}).click((function(){search($("#searchInput").val())})),$("#searchInput").keypress((function(e){13==e.which&&search($(this).val())})),$("#showExpert").button({disabled:!0}),$("#visitSite").button(),$("body").on("configurecreate",(function(e,t){"i-DefaultUrlHost-"!==t&&"i-ScriptUrlPath-"!==t&&"i-ScriptSuffix-"!==t||$("#"+t).change((function(){$("#visitSite");var e=$("#i-DefaultUrlHost-").val()+$("#i-ScriptUrlPath-").val()+"/view"+$("#i-ScriptSuffix-").val();$("#visitSite").attr("href",e).text(e)}))})),$("#saveButton").button({disabled:!t}).click((function(){confirm_action=function(){var t={wizard:"Save",method:"save",set:find_modified_values()};wizard_started(t),RPC("wizard","Save",t,(function(a){wizard_reports(t,e,a);var n=0;$.each(a.messages,(function(e,t){"errors"==t.level&&(n+=1)})),0===n&&($("#bootstrap_warning").remove(),$(".value_modified").each((function(){$(this).data("value_handler").commitVal(),update_modified_default($(this)),$(this).removeClass("value_modified")})),$("#saveButton").button("disable"))}),$(this))};var t=":<ul>";$("#bootstrap_warning").length&&(t=" complete basic configuration"+t),$(".value_modified").each((function(){var e=$(this).data("value_handler");t+="<li>"+e.spec.keys+"</li>"})),t+="</ul>",$("#confirm_note").html($("#saveMessage").html()),$("#confirm_note").append(t),$("#confirm_prompt").dialog("option","title","Confirm save"),$("#confirm_prompt").dialog("open")})),$(document).tooltip({tooltipClass:"info",show:{effect:"show",delay:500},hide:{effect:"hide",delay:200},track:!0,position:{my:"left+15 top+15",at:"left bottom",collision:"flipfit"}}),$(".help_button").each((function(){$(this).button({icon:$(this).attr("name"),text:!1})})),RPC("getspec","Load schema",{get:{parent:{depth:0}},depth:0},(function(t){e.empty().removeClass("loading"),load_section_specs(t,e),$("#showExpert").change((function(){this.checked?$(".expert").each((function(){$(this).removeClass("hidden_expert")})):$(".expert").each((function(){$(this).addClass("hidden_expert")}))})).button("enable"),RPC("check_current_value","Check all",{keys:[]},checker_reports)}))})),$(window).on("beforeunload",(function(){if($(".value_modified").length>0){var e="";return $("#bootstrap_warning").length&&(e=" complete basic configuration\n"),$(".value_modified").each((function(){var t=$(this).data("value_handler");e+="   "+t.spec.keys+"\n"})),"You have unsaved changes:\n"+e+"Are you really sure?\n"}}))}(jQuery);
