function Console(){}function searchNodeTreeForTagName(e,t){if(e.tagName==t)return e;for(var r=e.firstChild;null!=r;r=r.nextSibling){var o=searchNodeTreeForTagName(r,t);if(null!=o)return o}}function hasClass(e,t){if(e&&t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)}}function addClass(e,t){e&&t&&(hasClass(e,t)||(e.className=[e.className,t].join(" ")))}function removeClass(e,t){if(e&&t&&hasClass(e,t)){var r=new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)","g"),o=e.className;e.className=o.replace(r," ")}}function edittableInit(e,t,r,o){var n=document.forms[e];if(null!=n){attachEvent(n,"submit",submitTable);var s=searchNodeTreeForTagName(n,"TR");if(null!=s){var a=s.parentNode;sEditTable=new EditTable(n,a,r,o)}null!=s&&(insertActionButtons(t),insertRowSeparators()),sRowSelection=new RowSelectionObject(t),retrieveAlternatingRowColors(),fixStyling()}else alert("Problem loading JavaScript for EditTablePlugin: JavaScript features cannot be used.\n")}function submitTable(e){for(var t="",r=sEditTable.revidx.length,o=0;o<r;o++){var n="etrow_id"+(o+1),s=sEditTable.revidx[o]+1,a=sEditTable.rows[sEditTable.revidx[o]].getElementsByTagName("INPUT");if(a&&a[0]){var i=new RegExp("etcell([0-9]+)x[0-9]+"),l=a[0].name.match(i);l&&(s=l[1])}t+="\n"+o+" => name="+n+" => value="+s;var d=document.createElement("INPUT");d.setAttribute("type","hidden"),d.setAttribute("name",n),d.setAttribute("value",""+s),sEditTable.tableform.appendChild(d)}return DEBUG&&console.debug(t),!0}function attachEvent(e,t,r){r&&(window.addEventListener?e.addEventListener(t,r,!1):e.attachEvent("on"+t,r))}function detachEvent(e,t,r){r&&(window.addEventListener?e.removeEventListener(t,r,!1):e.detachEvent("on"+t,r))}function getEventAttr(e,t){return e.target?e.target[t]:e.srcElement[t]}function insertActionButtons(e){insertActionButtonsMove(e),insertActionButtonsDelete(e)}function insertActionButtonsMove(e){if(!(sEditTable.numrows<=1)){for(var t,r,o=0;o<sEditTable.numrows;o++){var n=sEditTable.revidx[o],s=sEditTable.rows[n];if("TR"==s.tagName){var a=isHeaderRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n),i=isFooterRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n,sEditTable.numrows);a||i?(t=document.createElement("TH"),(r=document.createElement("SPAN")).innerHTML="\x3c!--//--\x3e"):(t=document.createElement("TD"),r=createActionButtonMove(e,n),t.moveButton=r,addClass(t,"editTableActionCell")),t.id="et_actioncell"+n,t.appendChild(r),s.insertBefore(t,s.firstChild)}}addClass(t,"foswikiLast")}}function createActionButtonMove(e,t){var r=document.createElement("IMG");return r.setAttribute("title","Move row"),r.setAttribute("width","16"),r.setAttribute("height","16"),r.enableButtonSrc=e+"/btn_move.gif",r.disableButtonSrc=e+"/btn_move_disabled.gif",r.hoverButtonSrc=e+"/btn_move_over.gif",r.moveButtonSrc=e+"/btn_move.gif",r.setAttribute("src",r.enableButtonSrc),r.mohandler=mouseOverButtonHandler,attachEvent(r,"mouseover",r.mohandler),r.mouthandler=mouseOutButtonHandler,attachEvent(r,"mouseout",r.mouthandler),r.handler=moveHandler,attachEvent(r,"click",r.handler),addClass(r,"editTableActionButton"),r.rownr=t,r}function insertActionButtonsDelete(e){for(var t,r,o=0;o<sEditTable.numrows;o++){var n=sEditTable.revidx[o],s=sEditTable.rows[n];if("TR"==s.tagName){var a=isHeaderRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n),i=isFooterRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n,sEditTable.numrows);a||i?(t=document.createElement("TH"),(r=document.createElement("SPAN")).innerHTML="\x3c!--//--\x3e"):(t=document.createElement("TD"),r=createActionButtonDelete(e,n),t.moveButton=r,addClass(t,"editTableActionCell")),t.id="et_actioncell"+n,t.deleteButton=r,t.appendChild(r),insertAfter(t,s.lastChild)}}addClass(t,"foswikiLast")}function createActionButtonDelete(e,t){var r=document.createElement("IMG");return r.setAttribute("title","Delete row"),r.setAttribute("width","16"),r.setAttribute("height","16"),r.enableButtonSrc=e+"/btn_delete.gif",r.disableButtonSrc=e+"/btn_delete_disabled.gif",r.hoverButtonSrc=e+"/btn_delete_over.gif",r.setAttribute("src",r.enableButtonSrc),r.mohandler=mouseOverButtonHandler,attachEvent(r,"mouseover",r.mohandler),r.mouthandler=mouseOutButtonHandler,attachEvent(r,"mouseout",r.mouthandler),r.handler=deleteHandler,attachEvent(r,"click",r.handler),addClass(r,"editTableActionButton"),r.rownr=t,r}function insertRowSeparators(){for(var e,t,r,o=0;o<sEditTable.numrows;o++){var n=sEditTable.revidx[o],s=isHeaderRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n),a=isFooterRowArrayOrder(sEditTable.headerRows,sEditTable.footerRows,n,sEditTable.numrows);s||a||(t=makeSeparatorRow(n,r=countRowColumns(e=sEditTable.rows[n])),e.parentNode.insertBefore(t,e))}t=makeSeparatorRow(LAST_ROW_NR,r),e.parentNode.appendChild(t),sEditTable.last_separator=t}function makeSeparatorRow(e,t){var r=document.createElement("TR"),o=document.createElement("TD");o.colSpan=t,o.rownr=e;var n=document.createElement("DIV");return n.innerHTML="\x3c!--//--\x3e",n.rownr=e,o.appendChild(n),r.rownr=e,r.appendChild(o),r.cell=o,addClass(r,"editTableRowSeparator"),r.id="et_rowseparator"+e,r.ckhandler=sepClickHandler,r.mohandler=sepMouseOverHandler,r.mouthandler=sepMouseOutHandler,attachEvent(r,"click",r.ckhandler),attachEvent(r,"mouseover",r.mohandler),attachEvent(r,"mouseout",r.mouthandler),r}function countRowColumns(e){for(var t=0,r=e.firstChild;null!=r;r=r.nextSibling)"TD"!=r.tagName&&"TH"!=r.tagName||(t+=r.colSpan);return t}function selectRow(e){if(null!=e||null!=sRowSelection.row){if(null!=e){sRowSelection.row=sEditTable.rows[e],sRowSelection.rownum=e;var t=sRowSelection.row.previousSibling;sRowSelection.topSep=t;var r=sEditTable.positions[e]+1;if(r<sEditTable.numrows){var o=sEditTable.revidx[r];t=sEditTable.rows[o].previousSibling}else t=sEditTable.last_separator;sRowSelection.bottomSep=t}for(var n=sRowSelection.row.getElementsByTagName("TD"),s=0;s<n.length;++s)null!=e?(addClass(n[s],"editTableActionSelectedCell"),removeClass(n[s],"editTableActionSelectedCellDone")):(removeClass(n[s],"editTableActionSelectedCell"),addClass(n[s],"editTableActionSelectedCellDone"));null==e&&(sRowSelection.row=null,sRowSelection.rownum=null,sRowSelection.topSep=null,sRowSelection.bottomSep=null)}}function mouseOverButtonHandler(e){var t=e.srcElement?e.srcElement:e.target;t.src=t.hoverButtonSrc}function mouseOutButtonHandler(e){var t=e.srcElement?e.srcElement:e.target;t.src=t.enableButtonSrc}function moveHandler(e){if(null!=sRowSelection.rownum)return sRowSelection.rownum=null,selectRow(null),switchDeleteButtons(e),switchMoveButtons(e),void removeSeparatorAnimation();selectRow(getEventAttr(e,"rownr")),switchDeleteButtons(e),switchMoveButtons(e),addSeparatorAnimation()}function addSeparatorAnimation(){addClass(sEditTable.tableform,"editTableMoveMode")}function removeSeparatorAnimation(){removeClass(sEditTable.tableform,"editTableMoveMode")}function sepClickHandler(e){var t=getEventAttr(e,"rownr");null!=sRowSelection.rownum&&(moveRow(sRowSelection.rownum,t),selectRow(null),switchDeleteButtons(e),switchMoveButtons(e),removeSeparatorAnimation())}function sepMouseOverHandler(e){var t=e.srcElement?e.srcElement:e.target;null==sRowSelection.rownum?removeClass(t,"editTableRowSeparatorHover"):addClass(t,"editTableRowSeparatorHover")}function sepMouseOutHandler(e){removeClass(e.srcElement?e.srcElement:e.target,"editTableRowSeparatorHover")}function switchDeleteButtons(e){getEventAttr(e,"rownr");for(var t=null==sRowSelection.rownum?"to_enable":"to_disable",r=sEditTable.rows.length,o=0;o<r;++o){var n=sEditTable.rows[o].lastChild.deleteButton;n&&("to_enable"==t?(n.src=n.enableButtonSrc,attachEvent(n,"click",n.handler)):(n.src=n.disableButtonSrc,detachEvent(n,"click",n.handler)))}}function switchMoveButtons(e){getEventAttr(e,"rownr");for(var t=null==sRowSelection.rownum?"to_enable":"to_disable",r=sEditTable.rows.length,o=0;o<r;++o){var n=t;"to_disable"==t&&o==sRowSelection.rownum&&(n="to_enable");var s=sEditTable.rows[o].firstChild.moveButton;s&&("to_enable"==n?(s.src=s.enableButtonSrc,attachEvent(s,"click",s.handler)):(s.src=s.disableButtonSrc,detachEvent(s,"click",s.handler)))}}function deleteHandler(e){var t=getEventAttr(e,"rownr"),r=sEditTable.positions[t];DEBUG&&console.debug("deleteHandler rownr:"+t+"; from_row_pos="+r);var o=sEditTable.rows[t];o.parentNode.removeChild(o.previousSibling),o.parentNode.removeChild(o);for(var n=r+1;n<sEditTable.numrows;n++){var s=sEditTable.revidx[n],a=n-1;sEditTable.positions[s]=a,sEditTable.revidx[a]=s,updateRowLabels(s,-1)}sEditTable.revidx.pop(),sRowSelection.rownum==t&&selectRow(null),sEditTable.numrows--,updateTableChangesList(sEditTable,0),fixStyling()}function getChangesListValues(e,t,r,o){var n,s=new Array;n=e.length;for(var a=0;a<n;++a)s[a]=0;if(t.length<e.length)for(var i=e.length;i--;){var l=isFooterRowArrayOrder(r,o,i,e.length);isHeaderRowArrayOrder(r,o,i,e.length)||l?s[i]=0:void 0==t[i+o]?1==e[i]?s[i]=0:s[i]=-1:s[i]=e[i]}return s}function updateTableChangesList(e,t){if(!t){for(var r=getChangesListValues(e.initChangesList,e.revidx,e.headerRows,e.footerRows),o=new Array,n=0;n<r.length;++n){var s=r[n],a=n+1;o.push(a+"="+s)}var i=o.join(",");e.tableform[sET_TABLE_CHANGES_PARAM].value=i,DEBUG&&console.debug("changesMapString="+i)}}function createInitialChangesList(e,t){for(var r=new Array,o=0;o<t;++o)r[o]=0;if(e[sET_TABLE_CHANGES_PARAM]){var n=e[sET_TABLE_CHANGES_PARAM].value;if(n){var s=n.split(","),a=s.length;for(o=0;o<a;++o){var i=s[o].split("=");r[i[0]-1]=i[1]}}}return DEBUG&&console.debug("createInitialChangesList:"+r),r}function retrieveAlternatingRowColors(){if(sEditTable)for(var e=sEditTable.numrows,t=0;t<e;++t){for(var r=sEditTable.rows[t].getElementsByTagName("TD"),o=t%2==0?0:1,n=0;n<r.length;++n)if(null==sAlternatingColors[0]||null==sAlternatingColors[1]){var s=r[n].getAttribute("bgColor");s&&(sAlternatingColors[o]=s)}if(null!=sAlternatingColors[0]&&null!=sAlternatingColors[1])return}}function fixStyling(){if(sEditTable)for(var e=sEditTable.numrows,t=0;t<e;t++){var r=sEditTable.revidx[t],o=sEditTable.rows[r];removeClass(o,"foswikiTableEven"),removeClass(o,"foswikiTableOdd"),o.removeAttribute("bgColor");for(var n=o.getElementsByTagName("TD"),s=0;s<n.length;++s){var a=n[s];removeClass(a,"foswikiTableEven"),removeClass(a,"foswikiTableOdd"),removeClass(a,"foswikiLast"),a.removeAttribute("bgColor")}}}function moveRow(e,t){if(sEditTable){var r,o=sEditTable.positions[e];t==LAST_ROW_NR?(r=sEditTable.numrows-1-sEditTable.footerRows,t=sEditTable.revidx[r]):(r=sEditTable.positions[t])>o&&(r--,t=sEditTable.revidx[r]),DEBUG&&console.debug("moveRow; from_row_pos="+o+";to_row_pos="+r);var n=1;if((-1==r||o>r)&&(n=-1),e!=t){var s=sEditTable.rows[e],a=s.previousSibling;workaroundIECheckboxBug(s),s.parentNode.removeChild(a),s.parentNode.removeChild(s);for(var i=o+n;i!=r+n;i+=n){var l=sEditTable.revidx[i],d=i-n;sEditTable.positions[l]=d,sEditTable.revidx[d]=l,updateRowLabels(l,-n)}var u;1==n?(insertAfter(s,u=sEditTable.rows[t]),insertAfter(a,u)):(insertBefore(a,u=sEditTable.rows[t].previousSibling),insertBefore(s,u)),sEditTable.positions[e]=r,sEditTable.revidx[r]=e,updateRowLabels(e,r-o),updateTableChangesList(sEditTable,1),fixStyling()}}}function insertAfter(e,t){var r=t.parentNode;null==t.nextSibling?r.appendChild(e):r.insertBefore(e,t.nextSibling)}function insertBefore(e,t){t.parentNode.insertBefore(e,t)}function workaroundIECheckboxBug(e){for(var t=e.getElementsByTagName("INPUT"),r=0;null!=t[r];r++){var o=t[r];"radio"==o.type&&(o.defaultChecked=o.checked)}}function RowSelectionObject(e){return this.row=null,this.rownum=null,this.topSep=null,this.bottomSep=null,this}function EditTable(e,t,r,o){this.tableform=e,this.rows=new Array,this.positions=new Array,this.revidx=new Array,this.initChangesList=new Array,this.numrows=0,this.headerRows=r,this.footerRows=o,this.last_separator=null;for(var n=t;null!=n;){for(var s=n.firstChild;null!=s;)"TR"==s.tagName&&this.numrows++,s=s.nextSibling;n=n.nextSibling}n=t;for(var a=0;null!=n;){for(s=n.firstChild;null!=s;){if("TR"==s.tagName){var i=getRowId(this.headerRows,this.footerRows,a,this.numrows),l=i;this.rows[l]=s,this.positions[l]=l,this.revidx[l]=i,a++}s=s.nextSibling}n=n.nextSibling}return this.initChangesList=createInitialChangesList(e,this.positions.length),DEBUG&&console.dir(this),this}function updateRowLabels(e,t){if(sEditTable){var r=sEditTable.rows[e];if(r)for(var o=foswiki.getElementsByClassName(r,"et_rowlabel"),n=0;n<o.length;n++){var s=o[n],a=s.getElementsByTagName("INPUT").item(0),i=parseInt(a.value);for(i=isNaN(i)?"????":""+(i+t),a.value=i;null!=s.firstChild;)s.removeChild(s.firstChild);var l=document.createTextNode(i);s.appendChild(l),s.appendChild(a)}}}function init(){if(!foswiki.getMetaTag("EDITTABLEPLUGIN_NO_JAVASCRIPTINTERFACE_EditTableId")){var e=foswiki.getMetaTag("EDITTABLEPLUGIN_FormName"),t=foswiki.getMetaTag("EDITTABLEPLUGIN_EditTableUrl"),r=0;document.forms[e].etheaderrows&&(r=parseInt(document.forms[e].etheaderrows.value));var o=0;document.forms[e].etfooterrows&&(o=parseInt(document.forms[e].etfooterrows.value)),edittableInit(e,t,r,o)}}function isHeaderRowHtmlOrder(e,t,r){return e&&r<e}function isFooterRowHtmlOrder(e,t,r){if(isHeaderRowHtmlOrder(e,t,r))return!1;return t&&r>=e&&r<e+t}function isHeaderRowArrayOrder(e,t,r){return e&&r<e}function isFooterRowArrayOrder(e,t,r,o){if(isHeaderRowArrayOrder(e,t,r))return!1;return t&&r>=o-t}function getRowId(e,t,r,o){if(isHeaderRowHtmlOrder(e,t,r))return r;if(isFooterRowHtmlOrder(e,t,r)){return o-t+r-e}return r-t}function addLoadEvent(e,t){if("function"==typeof e){var r=window.onload;if("function"!=typeof window.onload)window.onload=function(){e()};else{window.onload=t?function(){e(),r()}:function(){r(),e()}}}}function testFunctions(){console.assert(1==isHeaderRowHtmlOrder(1,1,0),"isHeaderRowHtmlOrder true"),console.assert(0==isHeaderRowHtmlOrder(1,1,1),"isHeaderRowHtmlOrder false 1"),console.assert(0==isHeaderRowHtmlOrder(1,1,2),"isHeaderRowHtmlOrder false 2"),console.assert(0==isHeaderRowHtmlOrder(1,1,3),"isHeaderRowHtmlOrder false 3"),console.assert(0==isFooterRowHtmlOrder(1,1,0),"isFooterRowHtmlOrder false 1"),console.assert(1==isFooterRowHtmlOrder(1,1,1),"isFooterRowHtmlOrder true"),console.assert(0==isFooterRowHtmlOrder(1,1,2),"isFooterRowHtmlOrder false 2"),console.assert(0==isFooterRowHtmlOrder(1,1,3),"isFooterRowHtmlOrder false 3"),console.assert(0==isFooterRowHtmlOrder(2,2,0),"isFooterRowHtmlOrder 2/2 false 1"),console.assert(0==isFooterRowHtmlOrder(2,2,1),"isFooterRowHtmlOrder 2/2 false 2"),console.assert(1==isFooterRowHtmlOrder(2,2,2),"isFooterRowHtmlOrder 2/2 true 1"),console.assert(1==isFooterRowHtmlOrder(2,2,3),"isFooterRowHtmlOrder 2/2 true 2"),console.assert(0==isFooterRowHtmlOrder(2,2,4),"isFooterRowHtmlOrder 2/2 false 3"),console.assert(1==isHeaderRowArrayOrder(1,1,0),"isHeaderRowArrayOrder true"),console.assert(0==isHeaderRowArrayOrder(1,1,1),"isHeaderRowArrayOrder false 1"),console.assert(0==isHeaderRowArrayOrder(1,1,2),"isHeaderRowArrayOrder false 2"),console.assert(0==isHeaderRowArrayOrder(1,1,3),"isHeaderRowArrayOrder false 3"),console.assert(0==isFooterRowArrayOrder(1,1,0,4),"isFooterRowArrayOrder false 1"),console.assert(0==isFooterRowArrayOrder(1,1,1,4),"isFooterRowArrayOrder false 2"),console.assert(0==isFooterRowArrayOrder(1,1,2,4),"isFooterRowArrayOrder false 3"),console.assert(1==isFooterRowArrayOrder(1,1,3,4),"isFooterRowArrayOrder true"),console.assert(0==getRowId(1,1,0,5),"getRowId 1"),console.assert(4==getRowId(1,1,1,5),"getRowId 2"),console.assert(1==getRowId(1,1,2,5),"getRowId 3"),console.assert(2==getRowId(1,1,3,5),"getRowId 4"),console.assert(3==getRowId(1,1,4,5),"getRowId 5"),console.assert(0==getRowId(2,2,0,5),"getRowId 2/2 1"),console.assert(1==getRowId(2,2,1,5),"getRowId 2/2 2"),console.assert(3==getRowId(2,2,2,5),"getRowId 2/2 3"),console.assert(4==getRowId(2,2,3,5),"getRowId 2/2 4"),console.assert(2==getRowId(2,2,4,5),"getRowId 2/2 5")}var sEditTable,sRowSelection,console,sET_TABLE_CHANGES_PARAM="ettablechanges",sAlternatingColors=[],LAST_ROW_NR=-1,PERFORM_UNIT_TESTS=0,DEBUG=0;console||(Console.prototype.debug=function(e){window.alert(e)},Console.prototype.log=function(e){window.alert(e)},Console.prototype.assert=function(e,t){e||window.alert("assert fails:"+t)},Console.prototype.dir=function(e){var t="";for(var r in e)t+=r+"="+e[r]+"\n";window.alert(t)},console=new Console),Array.prototype.remove=function(e,t){var r=this.slice((t||e)+1||this.length);return this.length=e<0?this.length+e:e,this.push.apply(this,r)},PERFORM_UNIT_TESTS&&addLoadEvent(testFunctions,1),addLoadEvent(init);
